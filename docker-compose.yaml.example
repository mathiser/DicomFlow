version: "3"

services:
  rabbit:
    hostname: "rabbit"
    restart: always
    image: rabbitmq:3-management
    volumes:
      - ${RABBIT_DIR}/timeout.conf:/etc/rabbitmq/conf.d/timeout.conf
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 30s
      timeout: 30s
      retries: 3

  storescp:
    hostname: "storescp"
    restart: always
    ports:
      - "10000:10000"
    image: mathiser/dicom_flow-storescp
    environment:
      - PYTHONUNBUFFERED=1

  fingerprinter:
    hostname: "fingerprinter"
    restart: always
    image: mathiser/dicom_flow-fingerprinter
    environment:
      - PYTHONUNBUFFERED=1
    volumes:
      - ${FLOWS_DIR}:/opt/DicomFlow/flows

  scheduler:
    hostname: "scheduler"
    restart: always
    image: mathiser/dicom_flow-scheduler
    environment:
      - PYTHONUNBUFFERED=1

  consumer:
    hostname: "consumer"
    restart: always
    image: mathiser/dicom_flow-consumer
    environment:
      - PYTHONUNBUFFERED=1
      #- GPUS=0
      - CPUS=1
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  storescu:
    hostname: "storescu"
    restart: always
    depends_on:
      - rabbit
    image: mathiser/dicom_flow-storescu
    environment:
      - PYTHONUNBUFFERED=1

  flow_tracker:
    hostname: "flow-tracker"
    restart: always
    depends_on:
      - rabbit
    image: mathiser/dicom_flow-flow_tracker
    environment:
      - PYTHONUNBUFFERED=1
    volumes:
      - ${FLOWTRACKER_DIR}:/opt/DicomFlow/database:rw
      - ${LOGS_DIR}:/opt/DicomFlow/logs
    networks:
     - dicomflow_network

  file_storage:
    hostname: "file-storage"
    restart: always
    image: mathiser/dicom_flow-file_storage
    environment:
      - PYTHONUNBUFFERED=1
    volumes:
      - ${STATIC_DIR}:/opt/DicomFlow/static:ro
